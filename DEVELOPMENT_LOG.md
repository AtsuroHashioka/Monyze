# Monyze 開発記録

このファイルは、Monyzeプロジェクトの開発過程における重要な決定、実装ステップ、遭遇した問題とその解決策などを記録するためのものです。

---

## 開発計画

### フェーズ1: 基盤構築とユーザー認証 (完了)

*   [x] **データベース環境の構築**: Docker ComposeによるPostgreSQL環境の整備。
*   [x] **データベーススキーマの設計**: Prismaによる`User`, `Transaction`モデルの定義とマイグレーション。
*   [x] **認証バックエンドの実装**: NextAuth.jsとbcryptによる認証ロジックの構築。

### フェーズ2: 認証・登録UIの実装

*   [ ] **新規登録APIの作成**: ユーザー情報をデータベースに保存するAPIエンドポイントを作成する。
*   [ ] **UIコンポーネントの作成**: ログインフォーム、新規登録フォームなどのUIを実装する。
*   [ ] **認証状態の管理**: ログイン状態に応じて表示を切り替える処理を実装する。

### フェーズ3: 家計簿機能の実装

*   [ ] **収支登録フォームの作成**: 収入・支出を登録するUIを作成する。
*   [ ] **収支登録APIの作成**: 登録されたデータをデータベースに保存するAPIを作成する。
*   [ ] **収支一覧表示**: 登録された収支データを一覧で表示するページを作成する。

---

## 開発記録

## 1. データベースの準備：Dockerで「データの保管庫」を用意しよう

アプリのデータ（ユーザー情報や収支記録）を保存する場所が必要です。これを「データベース」と呼びます。今回はPostgreSQLというデータベースを使いますが、PCに直接インストールするのではなく、「Docker」という便利なツールを使います。

**Dockerとは？**
あなたのPCの中に、他の環境から隔離された仮想的な「開発部屋（コンテナ）」を作ってくれるツールです。この部屋の中にデータベースを置くことで、あなたのPC本体の環境を汚さずに済み、後片付けも簡単になります。

---

### 手順1: データベースの「設計図」を作る (`docker-compose.yml`)

まず、Dockerに「どんな開発部屋を作ってほしいか」を指示する設計図ファイル (`docker-compose.yml`) を用意します。

```dockercompose
version: '3.8'

services:
  db:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_DB: monyze
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data

volumes:
  db_data:
```

### 手順2: パスワードを「秘密のメモ」に書く (`.env`)

設計図に直接パスワードを書くのは危険です。そこで、別の「秘密のメモ」ファイル (`.env`) を作り、そこにパスワードを書いておきます。このファイルは `.gitignore` に記載して、GitHubなどにはアップロードしないようにします。

### 手順3: データベースを起動する！

設計図と秘密のメモができたので、Dockerに開発部屋を作ってもらいましょう。プロジェクトのルートディレクトリで以下のコマンドを実行します。

```bash
# 設計図を元に、バックグラウンドで開発部屋を起動して！
docker-compose up -d
```

これで、あなたのPCの裏側でPostgreSQLデータベースが動き始めました！

---

## 2. データベースの設計：Prismaで「データの形」を決めよう

データベースが用意できたので、次に「どんなデータを保存するか」の設計をします。ここで登場するのが「Prisma」です。

**Prismaとは？**
アプリ（Next.js）とデータベース（PostgreSQL）の間に立ってくれる「通訳」です。Prismaを使えば、難しいデータベース言語（SQL）を書かなくても、簡単にデータを操作できます。

### 手順1: Prismaの初期設定と「設計書」の作成

まず、Prismaをインストールし、初期設定を行います。

```bash
# frontendディレクトリに移動
cd frontend
# Prismaをインストール
npm install prisma --save-dev
# Prismaの初期設定（schema.prismaファイルなどが作られる）
npx prisma init
```

次に、Prismaの「設計書」である `schema.prisma` ファイルに、どんなデータを保存したいかを書いていきます。

### 手順2: アプリにデータベースの「住所」を教える

Prismaがデータベースに接続できるよう、`frontend/.env` ファイルにデータベースの「住所」(`DATABASE_URL`)を教えます。

### 手順3: 設計書をデータベースに反映させる（マイグレーション）

最後に、Prismaの設計書を、Dockerで動いている実際のデータベースに反映させます。この作業を「マイグレーション」と呼びます。

```bash
# 設計書（schema.prisma）の通りに、データベースのテーブルを作って！
npx prisma migrate dev --name init_user_and_transaction_tables
```

---

## 3.【重要】よくあるトラブルと解決策

マイグレーション実行時に `Authentication failed` (認証失敗) というエラーが出ることがあります。

**原因:**
Dockerで一度作ったデータベースは、最初のユーザー名とパスワードを記憶しています。後からパスワードなどを変更しても、古いデータが残っていると、新しいパスワードでログインできません。

**解決策:**
古いデータベースのデータごと、コンテナを完全に削除して作り直します。

```bash
# プロジェクトのルートディレクトリで実行

# コンテナと、データ保管場所（ボリューム）も一緒に削除して！
docker-compose down -v

# もう一度、まっさらな状態でコンテナを起動して！
docker-compose up -d
```

この後、再度 `npx prisma migrate dev` を実行すれば、今度は成功するはずです。

---

## 4. ユーザー認証の準備：NextAuth.jsでログインの仕組みを作ろう

データベースの土台ができたので、次はユーザーがログイン・新規登録するための仕組みを作ります。これには`NextAuth.js`という認証の専門家ライブラリを使います。

### 手順1: 必要な道具（ライブラリ）をインストール

認証機能とパスワードを安全に管理するための道具をインストールします。

```bash
# frontendディレクトリで実行
npm install next-auth bcrypt
npm install --save-dev @types/bcrypt
```
*   `next-auth`: ログインやログアウトの仕組みを簡単に作れるライブラリ。
*   `bcrypt`: パスワードを安全な暗号に変換してくれるライブラリ。

### 手順2: データベースとの「専用通路」を作成

アプリがデータベースと効率よく通信するための専用ファイル (`/src/lib/prisma.ts`) を作成します。これにより、不必要なデータベース接続が増えるのを防ぎ、アプリを安定させます。

### 手順3: 認証の「司令塔」を作成

NextAuth.jsが認証処理を行うための中心的なファイル (`/src/app/api/auth/[...nextauth]/route.ts`) を作成します。このファイルに、「メールアドレスとパスワードが送られてきたら、データベースの情報と照合して本人確認を行う」という具体的な手順を記述しました。

### 手順4: セキュリティのための「秘密の鍵」を設定

ログイン状態を安全に保つための「秘密の鍵」(`NEXTAUTH_SECRET`) を生成し、`frontend/.env` ファイルに設定しました。これにより、第三者がセッション情報を盗み見るのを防ぎます。

### 次のステップ
これで、ユーザー認証機能のバックエンド（裏側の処理）の準備が整いました。
次のステップでは、ユーザーが実際にメールアドレスやパスワードを入力するための「ログインページ」や「新規登録ページ」の見た目（UI）を作成していきます。